generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}



// Add to your existing schema
model ProductImage {
  id          String   @id @default(uuid())
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  // Image URLs
  url         String
  thumbnailUrl String?
  mediumUrl   String?
  
  // Image metadata
  altText     String?
  isFeatured  Boolean  @default(false)
  displayOrder Int     @default(0)
  
  // Dimensions
  width       Int?
  height      Int?
  size        Int?     // in bytes
  format      String?  // jpg, png, webp
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([productId])
  @@index([isFeatured])
  @@index([displayOrder])
}

// Add these models to your existing schema.prisma

model Payment {
  id              String    @id @default(uuid())
  orderId         String
  order           Order     @relation(fields: [orderId], references: [id])
  amount          Float
  currency        String    @default("USD")
  paymentMethod   String?   // card, paypal, etc
  paymentGateway  String?   // stripe, paypal, etc
  paymentIntentId String?   @unique
  clientSecret    String?
  transactionId   String?
  status          PaymentStatus @default(PENDING)
  paidAt          DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  refunds         Refund[]

  @@index([orderId])
  @@index([paymentIntentId])
  @@index([status])
}

model Refund {
  id              String    @id @default(uuid())
  orderId         String
  order           Order     @relation(fields: [orderId], references: [id])
  paymentId       String
  payment         Payment   @relation(fields: [paymentId], references: [id])
  amount          Float
  currency        String    @default("USD")
  refundId        String?   @unique // External refund ID
  reason          String?
  status          RefundStatus @default(PENDING)
  processedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([orderId])
  @@index([paymentId])
  @@index([status])
}

model Shipment {
  id                String    @id @default(uuid())
  orderId           String
  order             Order     @relation(fields: [orderId], references: [id])
  trackingNumber    String    @unique
  carrier           String
  service           String
  shippingCost      Float
  estimatedDelivery DateTime?
  actualDelivery    DateTime?
  status            ShipmentStatus @default(PENDING)
  labelUrl          String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([orderId])
  @@index([trackingNumber])
  @@index([status])
}

model Supplier {
  id            String    @id @default(uuid())
  name          String
  email         String?
  phone         String?
  address       Json?
  taxId         String?
  contactPerson String?
  paymentTerms  String?   @default("NET30")
  minimumOrder  Float?    @default(0)
  leadTime      Int?      @default(7) // days
  status        SupplierStatus @default(ACTIVE)
  notes         String?

  products      Product[]
  purchaseOrders PurchaseOrder[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([name])
  @@index([email])
  @@index([status])
}

model PurchaseOrder {
  id                String    @id @default(uuid())
  supplierId        String
  supplier          Supplier  @relation(fields: [supplierId], references: [id])
  poNumber          String    @unique
  items             Json      // Array of {productId, quantity, unitPrice, total, expectedDelivery}
  subtotal          Float
  tax               Float     @default(0.0)
  totalAmount       Float
  status            POStatus  @default(PENDING)
  expectedDelivery  DateTime?
  receivedAt        DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([supplierId])
  @@index([poNumber])
  @@index([status])
  @@index([expectedDelivery])
}

model InventoryTransaction {
  id          String    @id @default(uuid())
  productId   String
  product     Product   @relation(fields: [productId], references: [id])
  type        InventoryTransactionType
  quantity    Int
  unitCost    Float?
  referenceId String?   // PO ID, Order ID, etc
  notes       String?
  createdAt   DateTime  @default(now())

  @@index([productId])
  @@index([type])
  @@index([createdAt])
}

// Add these enums to your existing enums

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum RefundStatus {
  PENDING
  PROCESSED
  FAILED
}

enum ShipmentStatus {
  PENDING
  PROCESSED
  IN_TRANSIT
  DELIVERED
  RETURNED
}

enum SupplierStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum POStatus {
  PENDING
  APPROVED
  ORDERED
  PARTIALLY_RECEIVED
  COMPLETED
  CANCELLED
}

enum InventoryTransactionType {
  PURCHASE
  SALE
  RETURN
  ADJUSTMENT
  DAMAGE
  TRANSFER
}



model Product {
  id                String    @id @default(uuid())
  
  // Basic Information
  name              String
  slug              String    @unique
  sku               String    @unique
  description       String?
  shortDescription  String?
  
  // Pricing
  price             Float
  compareAtPrice    Float?
  costPrice         Float?
  taxRate           Float?    @default(0.0)
  
  // Inventory
  stockQuantity     Int       @default(0)
  lowStockThreshold Int       @default(10)
  trackInventory    Boolean   @default(true)
  allowBackorders   Boolean   @default(false)
  isDigital         Boolean   @default(false)
  weight            Float?    // in kg
  dimensions        Json?     // {length, width, height}
  
  // Organization
  categoryId        String?
  category          Category? @relation(fields: [categoryId], references: [id])
  brand             String?
  tags              String[]
  
  // Media
  images            Json      // Array of image objects
  featuredImage     String?
  videoUrl          String?
  
  // Variants
  hasVariants       Boolean   @default(false)
  variantOptions    Json?     // Array of {name, values}
  variants          ProductVariant[]
  
  // SEO
  metaTitle         String?
  metaDescription   String?
  metaKeywords      String[]
  
  // Status
  status            ProductStatus @default(DRAFT)
  visibility        VisibilityStatus @default(VISIBLE)
  isFeatured        Boolean   @default(false)
  isBestSeller      Boolean   @default(false)
  isNew             Boolean   @default(false)
  
  // Ratings
  rating            Float     @default(0)
  reviewCount       Int       @default(0)
  
  // Relations
  reviews           Review[]
  cartItems         CartItem[]
  orderItems        OrderItem[]
  wishlistItems     WishlistItem[]
  
  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  publishedAt       DateTime?
  
  @@index([slug])
  @@index([sku])
  @@index([categoryId])
  @@index([status])
  @@index([isFeatured])
  @@index([rating])
  @@index([createdAt])
}

model ProductVariant {
  id                String    @id @default(uuid())
  productId         String
  product           Product   @relation(fields: [productId], references: [id])
  
  // Variant Options
  option1           String?
  option2           String?
  option3           String?
  sku               String    @unique
  price             Float
  compareAtPrice    Float?
  costPrice         Float?
  
  // Inventory
  stockQuantity     Int       @default(0)
  trackInventory    Boolean   @default(true)
  
  // Media
  image             String?
  
  // Status
  status            ProductStatus @default(ACTIVE)
  
  // Relations
  cartItems         CartItem[]
  orderItems        OrderItem[]
  
  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([productId])
  @@index([sku])
  @@unique([productId, option1, option2, option3])
}

model Category {
  id                String    @id @default(uuid())
  
  // Basic Information
  name              String
  slug              String    @unique
  description       String?
  image             String?
  
  // Hierarchy
  parentId          String?
  parent            Category? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children          Category[] @relation("CategoryHierarchy")
  
  // SEO
  metaTitle         String?
  metaDescription   String?
  
  // Display
  displayOrder      Int       @default(0)
  isActive          Boolean   @default(true)
  
  // Relations
  products          Product[]
  
  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([slug])
  @@index([parentId])
  @@index([displayOrder])
}

model Cart {
  id                String    @id @default(uuid())
  userId            String?
  sessionId         String?
  
  // Customer Information
  customerEmail     String?
  customerPhone     String?
  
  // Cart Details
  items             CartItem[]
  itemCount         Int       @default(0)
  totalQuantity     Int       @default(0)
  subtotal          Float     @default(0.0)
  tax               Float     @default(0.0)
  discount          Float     @default(0.0)
  shipping          Float     @default(0.0)
  totalAmount       Float     @default(0.0)
  currency          String    @default("USD")
  
  // Applied Promotions
  couponCode        String?
  discountType      String?   // percentage, fixed
  discountValue     Float?
  
  // Shipping
  shippingMethod    String?
  shippingAddress   Json?
  
  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  expiresAt         DateTime  @default(now() + 30d)
  
  @@index([userId])
  @@index([sessionId])
  @@index([expiresAt])
}

model CartItem {
  id                String    @id @default(uuid())
  cartId            String
  cart              Cart      @relation(fields: [cartId], references: [id], onDelete: Cascade)
  
  productId         String
  product           Product   @relation(fields: [productId], references: [id])
  variantId         String?
  variant           ProductVariant? @relation(fields: [variantId], references: [id])
  
  // Item Details
  quantity          Int       @default(1)
  price             Float
  compareAtPrice    Float?
  totalPrice        Float     @default(0.0)
  
  // Customizations
  customizations    Json?     // {size: "L", color: "Red", engraving: "Text"}
  
  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([cartId])
  @@index([productId])
  @@unique([cartId, productId, variantId])
}

model Order {
  id                String    @id @default(uuid())
  orderNumber       String    @unique
  userId            String?
  
  // Customer Information
  customerEmail     String
  customerName      String
  customerPhone     String?
  customerNote      String?
  
  // Order Status
  status            OrderStatus @default(PENDING)
  paymentStatus     PaymentStatus @default(PENDING)
  fulfillmentStatus FulfillmentStatus @default(UNFULFILLED)
  
  // Pricing
  subtotal          Float
  tax               Float     @default(0.0)
  discount          Float     @default(0.0)
  shipping          Float     @default(0.0)
  totalAmount       Float
  currency          String    @default("USD")
  taxRate           Float     @default(0.0)
  
  // Payment
  paymentMethod     String?
  transactionId     String?
  paymentGateway    String?   // stripe, paypal, etc.
  paidAt            DateTime?
  
  // Shipping
  shippingMethod    String?
  shippingAddress   Json
  billingAddress    Json?
  trackingNumber    String?
  shippedAt         DateTime?
  deliveredAt       DateTime?
  
  // Discounts
  couponCode        String?
  discountType      String?
  discountValue     Float?
  
  // Items
  items             OrderItem[]
  
  // Relations
  user              User?     @relation(fields: [userId], references: [id])
  
  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  cancelledAt       DateTime?
  refundedAt        DateTime?
  
  @@index([orderNumber])
  @@index([userId])
  @@index([status])
  @@index([customerEmail])
  @@index([createdAt])
}

model OrderItem {
  id                String    @id @default(uuid())
  orderId           String
  order             Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  productId         String
  product           Product   @relation(fields: [productId], references: [id])
  variantId         String?
  variant           ProductVariant? @relation(fields: [variantId], references: [id])
  
  // Item Details
  name              String
  sku               String
  quantity          Int
  price             Float
  compareAtPrice    Float?
  totalPrice        Float
  taxAmount         Float     @default(0.0)
  
  // Customizations
  customizations    Json?
  
  // Digital Product
  digitalFileUrl    String?
  downloadKey       String?   @unique
  downloadsUsed     Int       @default(0)
  maxDownloads      Int       @default(3)
  
  @@index([orderId])
  @@index([productId])
}

model Review {
  id                String    @id @default(uuid())
  productId         String
  product           Product   @relation(fields: [productId], references: [id])
  userId            String
  user              User      @relation(fields: [userId], references: [id])
  orderId           String?
  
  // Review Content
  rating            Int       @min(1) @max(5)
  title             String?
  comment           String
  images            String[]
  
  // Status
  status            ReviewStatus @default(PENDING)
  isVerified        Boolean   @default(false)
  helpfulCount      Int       @default(0)
  
  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([productId])
  @@index([userId])
  @@index([rating])
  @@index([status])
  @@unique([productId, userId, orderId])
}

model Wishlist {
  id                String    @id @default(uuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id])
  
  // Items
  items             WishlistItem[]
  itemCount         Int       @default(0)
  
  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([userId])
}

model WishlistItem {
  id                String    @id @default(uuid())
  wishlistId        String
  wishlist          Wishlist  @relation(fields: [wishlistId], references: [id], onDelete: Cascade)
  
  productId         String
  product           Product   @relation(fields: [productId], references: [id])
  variantId         String?
  variant           ProductVariant? @relation(fields: [variantId], references: [id])
  
  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([wishlistId])
  @@index([productId])
  @@unique([wishlistId, productId, variantId])
}

model Coupon {
  id                String    @id @default(uuid())
  code              String    @unique
  description       String?
  
  // Discount Details
  discountType      DiscountType @default(PERCENTAGE)
  discountValue     Float
  minimumPurchase   Float?
  maximumDiscount   Float?
  
  // Usage Limits
  usageLimit        Int?      // Total usage limit
  usageCount        Int       @default(0)
  perUserLimit      Int?      // Limit per user
  userUsageCount    Json?     // Map of userId -> usage count
  
  // Applicability
  applicableTo      CouponApplicableTo @default(ALL)
  productIds        String[]
  categoryIds       String[]
  
  // Validity
  startsAt          DateTime
  expiresAt         DateTime?
  isActive          Boolean   @default(true)
  
  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([code])
  @@index([isActive])
  @@index([expiresAt])
}

// Subscription Models
model SubscriptionPlan {
  id                String    @id @default(uuid())
  name              String
  description       String?
  price             Float
  interval          SubscriptionInterval @default(MONTH)
  intervalCount     Int       @default(1)
  trialDays         Int       @default(0)
  
  // Features
  features          Json      // Array of feature objects
  isActive          Boolean   @default(true)
  isPopular         Boolean   @default(false)
  
  // Limits
  classLimit        Int?
  liveSessionLimit  Int?
  productDiscount   Float?
  
  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([isActive])
  @@index([price])
}

model Subscription {
  id                String    @id @default(uuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id])
  planId            String
  plan              SubscriptionPlan @relation(fields: [planId], references: [id])
  
  // Status
  status            SubscriptionStatus @default(ACTIVE)
  cancelAtPeriodEnd Boolean   @default(false)
  
  // Period
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  canceledAt        DateTime?
  endedAt           DateTime?
  
  // Payment
  stripeSubscriptionId String?  @unique
  stripeCustomerId   String?
  
  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([currentPeriodEnd])
}

// Enums
enum ProductStatus {
  DRAFT
  ACTIVE
  ARCHIVED
  OUT_OF_STOCK
  DISCONTINUED
}

enum VisibilityStatus {
  VISIBLE
  HIDDEN
  SEARCHABLE
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum FulfillmentStatus {
  UNFULFILLED
  PARTIALLY_FULFILLED
  FULFILLED
  DELIVERED
  RETURNED
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_SHIPPING
}

enum CouponApplicableTo {
  ALL
  PRODUCTS
  CATEGORIES
  USERS
}

enum SubscriptionInterval {
  DAY
  WEEK
  MONTH
  YEAR
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELLED
  EXPIRED
  TRIALING
}

// User reference (from user-service)
model User {
  id                String    @id @default(uuid())
  email             String    @unique
  
  // For ecommerce relations
  orders            Order[]
  reviews           Review[]
  wishlist          Wishlist?
  subscriptions     Subscription[]
  cart              Cart?
}