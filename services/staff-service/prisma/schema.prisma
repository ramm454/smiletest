generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Staff Core
model Staff {
  id              String    @id @default(uuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id])
  employeeId      String?   @unique
  department      String
  position        String
  hireDate        DateTime
  salary          Float?
  employmentType  String    // full_time, part_time, contractor
  hourlyRate      Float?
  maxHoursPerWeek Int?
  skills          String[]
  certifications  String[]
  emergencyContact Json?
  bankDetails     Json?
  isActive        Boolean   @default(true)
  
  // Audit
  createdBy       String
  updatedBy       String?
  
  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  availabilities      Availability[]
  shifts             Shift[]
  payrolls           Payroll[]
  tasks              Task[]
  performanceReviews PerformanceReview[]
  timeOffRequests    TimeOffRequest[]
  scheduleTemplates  ScheduleTemplate[]
  taskTemplates      TaskTemplate[]
  vacationBalances   VacationBalance[]
  
  @@index([department])
  @@index([position])
  @@index([employmentType])
  @@index([isActive])
  @@index([createdAt])
}

// Schedule Management
model Schedule {
  id                String   @id @default(uuid())
  staffId           String
  staff             Staff    @relation(fields: [staffId], references: [id])
  parentScheduleId  String?
  parentSchedule    Schedule? @relation("RecurringSchedules", fields: [parentScheduleId], references: [id])
  recurringSchedules Schedule[] @relation("RecurringSchedules")
  
  type              String   // shift, meeting, training, etc.
  startTime         DateTime
  endTime           DateTime
  recurrenceRule    String?
  timezone          String   @default("Europe/Vienna")
  location          String?
  notes             String?
  status            String   // scheduled, in_progress, completed, cancelled
  
  // External calendar integration
  googleEventId     String?
  outlookEventId    String?
  appleEventId      String?
  
  // Audit
  createdBy         String
  updatedBy         String?
  
  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Metadata
  metadata          Json?
  
  @@index([staffId])
  @@index([startTime])
  @@index([endTime])
  @@index([status])
  @@index([parentScheduleId])
}

model ScheduleTemplate {
  id          String   @id @default(uuid())
  name        String
  description String?
  department  String
  shifts      Json     // Array of shift definitions
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  metadata    Json?
  
  @@index([department])
  @@index([createdAt])
}

model ShiftSwapRequest {
  id              String   @id @default(uuid())
  fromScheduleId  String
  fromSchedule    Schedule @relation(fields: [fromScheduleId], references: [id])
  fromStaffId     String
  fromStaff       Staff    @relation("FromStaff", fields: [fromStaffId], references: [id])
  toStaffId       String
  toStaff         Staff    @relation("ToStaff", fields: [toStaffId], references: [id])
  requestedById   String
  requestedBy     User     @relation(fields: [requestedById], references: [id])
  reason          String?
  status          String   // pending, approved, rejected
  processedById   String?
  processedBy     User?    @relation("ProcessedBy", fields: [processedById], references: [id])
  processedAt     DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([fromScheduleId])
  @@index([fromStaffId])
  @@index([toStaffId])
  @@index([status])
  @@index([createdAt])
}

// Time Off Management
model TimeOffRequest {
  id            String   @id @default(uuid())
  staffId       String
  staff         Staff    @relation(fields: [staffId], references: [id])
  type          String   // vacation, sick, personal, parental, etc.
  startDate     DateTime
  endDate       DateTime
  workingDays   Int
  reason        String?
  status        String   // pending, approved, rejected, cancelled
  requestedById String
  requestedBy   User     @relation(fields: [requestedById], references: [id])
  processedById String?
  processedBy   User?    @relation("TimeOffProcessedBy", fields: [processedById], references: [id])
  processedAt   DateTime?
  notes         String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([staffId])
  @@index([startDate])
  @@index([endDate])
  @@index([status])
  @@index([type])
}

model VacationBalance {
  id          String   @id @default(uuid())
  staffId     String
  staff       Staff    @relation(fields: [staffId], references: [id])
  year        Int
  totalDays   Int      @default(25) // Austrian minimum
  usedDays    Int      @default(0)
  carriedOver Int      @default(0)
  notes       String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([staffId, year])
  @@index([staffId])
  @@index([year])
}

// Payroll Management (Austrian)
model Payroll {
  id             String   @id @default(uuid())
  staffId        String
  staff          Staff    @relation(fields: [staffId], references: [id])
  periodStart    DateTime
  periodEnd      DateTime
  
  // Earnings
  baseSalary     Float
  overtimePay    Float    @default(0)
  bonus          Float    @default(0)
  
  // Deductions
  deductions     Float    @default(0)
  taxAmount      Float
  netPay         Float
  
  // Payment
  paymentMethod  String   // SEPA, cash, check
  paymentDate    DateTime?
  status         String   // pending, processing, paid, failed
  
  // Austrian Specific
  taxClass       String?  // I, II, III, IV, V
  children       Int?     @default(0)
  isSingleParent Boolean? @default(false)
  
  // Audit
  createdBy      String
  updatedBy      String?
  
  // Timestamps
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  // Metadata
  metadata       Json?    // Contains Lohnzettel, SEPA file, calculations
  
  @@index([staffId])
  @@index([periodStart])
  @@index([periodEnd])
  @@index([status])
  @@index([paymentDate])
}

// Task Management
model Task {
  id              String   @id @default(uuid())
  title           String
  description     String?
  assignedToId    String?
  assignedTo      Staff?   @relation("AssignedTo", fields: [assignedToId], references: [id])
  assignedById    String
  assignedBy      User     @relation("AssignedBy", fields: [assignedById], references: [id])
  
  dueDate         DateTime
  priority        String   // critical, high, medium, low
  category        String   // administrative, customer_service, maintenance, etc.
  status          String   // pending, in_progress, completed, cancelled
  progress        Int      @default(0) // 0-100
  
  estimatedHours  Float?
  completedAt     DateTime?
  completionNotes String?
  
  // Recurring tasks
  parentTaskId    String?
  parentTask      Task?    @relation("RecurringTasks", fields: [parentTaskId], references: [id])
  recurringTasks  Task[]   @relation("RecurringTasks")
  
  // Audit
  createdBy       String
  updatedBy       String?
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Metadata
  metadata        Json?    // Contains attachments, progress history, checklist
  
  // Relations
  dependencies    TaskDependency[] @relation("Dependencies")
  dependentTasks  TaskDependency[] @relation("DependentTasks")
  
  @@index([assignedToId])
  @@index([assignedById])
  @@index([dueDate])
  @@index([priority])
  @@index([status])
  @@index([category])
  @@index([parentTaskId])
}

model TaskDependency {
  id          String   @id @default(uuid())
  taskId      String
  task        Task     @relation("DependentTasks", fields: [taskId], references: [id])
  dependsOnId String
  dependsOn   Task     @relation("Dependencies", fields: [dependsOnId], references: [id])
  
  createdAt   DateTime @default(now())
  
  @@unique([taskId, dependsOnId])
  @@index([taskId])
  @@index([dependsOnId])
}

model TaskTemplate {
  id            String   @id @default(uuid())
  name          String
  description   String?
  category      String
  priority      String
  estimatedHours Float?
  checklist     Json?    // Array of checklist items
  dependencies  String[] // Array of template IDs
  createdBy     String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  metadata      Json?
  
  @@index([category])
  @@index([priority])
}

// Performance Management
model PerformanceReview {
  id                  String   @id @default(uuid())
  staffId             String
  staff               Staff    @relation(fields: [staffId], references: [id])
  reviewerId          String
  reviewer            User     @relation(fields: [reviewerId], references: [id])
  
  rating              Float    @min(1) @max(5)
  comment             String?
  strengths           String[]
  areasForImprovement String[]
  goals               String[]
  
  // 360-degree feedback
  feedbackFrom        Json?    // Array of feedback from peers
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@index([staffId])
  @@index([reviewerId])
  @@index([createdAt])
  @@index([rating])
}

// Existing models (from earlier)
model Availability {
  id           String   @id @default(uuid())
  staffId      String
  staff        Staff    @relation(fields: [staffId], references: [id])
  dayOfWeek    Int      // 0-6 (Sunday-Saturday)
  startTime    String   // "09:00"
  endTime      String   // "17:00"
  timezone     String   @default("UTC")
  isRecurring  Boolean  @default(true)
  validFrom    DateTime
  validTo      DateTime?
  
  createdAt    DateTime @default(now())
  
  @@unique([staffId, dayOfWeek, startTime, endTime])
  @@index([staffId])
  @@index([dayOfWeek])
  @@index([isRecurring])
}

model Shift {
  id               String   @id @default(uuid())
  staffId          String
  staff            Staff    @relation(fields: [staffId], references: [id])
  startTime        DateTime
  endTime          DateTime
  breakDuration    Int?     // minutes
  location         String
  notes            String?
  status           String   // scheduled, in_progress, completed, cancelled
  clockInTime      DateTime?
  clockOutTime     DateTime?
  actualDuration   Int?     // minutes
  overtimeDuration Int?
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@index([staffId])
  @@index([startTime])
  @@index([status])
  @@index([clockInTime])
}

// Reference to user-service User model
model User {
  id          String   @id @default(uuid())
  email       String   @unique
  firstName   String?
  lastName    String?
  avatar      String?
  
  // For staff service
  staff       Staff?
  
  // Relations
  assignedTasks Task[]   @relation("AssignedBy")
  performanceReviews PerformanceReview[]
  shiftSwapRequests ShiftSwapRequest[] @relation("RequestedBy")
  processedShiftSwaps ShiftSwapRequest[] @relation("ProcessedBy")
  timeOffRequests TimeOffRequest[] @relation("RequestedBy")
  processedTimeOff TimeOffRequest[] @relation("TimeOffProcessedBy")
}